---
title: "Atlas of Deprivation in Wales"
author: "Dr Robert Berry, Countryside and Community Research Institute (CCRI)"
date: "08 July 2020"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    smooth_scroll: true
    theme: united
    highlight: tango  # specifies the syntax highlighting style
---
<a href = "mailto:raberry@glos.ac.uk?subject=WIMD Atlas">Email</a>; <a href="http://www.ccri.ac.uk/berry/" target="_blank">Staff page</a>; <a href="https://twitter.com/rural_gis" target="_blank">@rural_gis</a>; <a href="http://www.ccri.ac.uk/" target="_blank">CCRI Website</a>  

![](C:/Users\\Rob\\Dropbox\\R\\4_Projects\\Work\\WalesDeprivationAtlas\\Web_page\\Banner.png)


## 1. Deprivation

People are described as being *deprived* when they are lacking in resources considered to be basic necessities in society. While income poverty plays a major role in determining the level of socio-economic deprivation experienced by an individual or community, health, access to services, and the quality of the built and natural environment are also important factors. People who are more deprived are likely to be more vulnerable to (and less able to recover from) a range of shocks and challenges. The current Coronavirus pandemic, for example, has thrown into sharp focus the link between deprivation and vulnerability to health and economic shocks. In Wales (and the wider UK), preliminary analysis of official data on Coronavirus infection and mortality rates has found the impact of the disease has been greater in more deprived areas of the country - a phenomenon that has been widely discussed and <a href="https://www.bbc.co.uk/news/uk-wales-53021842" target="_blank">reported</a>. The short and long-term economic impacts of the Coronavirus lockdown and social distancing measures is also likely to be more severe in areas where deprivation is higher. 


## 2. Welsh Index of Multiple Deprivation (WIMD){#custom3}
Produced by the Welsh Government, the Welsh Index of Multiple Deprivation (WIMD) is a dataset providing statistics on **relative** deprivation for small geographical areas across Wales. Used widely by researchers and policy/decison-makers, WIMD ranks these small areas (called Lower Super Output Areas - LSOAs) from 1 (most deprived) to 1909 (least deprived). The average popualtion of a LSOA in Wales is around 1,600 people. As the measure is relative, it is not possible, for example, to say that LSOA A is *x* times more deprived than LSOA B, only that it is more deprived. When interpreting WIMD data and maps, it is important to keep in mind that there will be many people living in the most deprived areas who may not be deprived. Conversely, there will be people living in less deprived areas who are deprived.

As WIMD LSOA scores are relative rather than absolute, analysing deprivation across larger geographical areas (e.g. local authorities) is done by comparing the proportion of LSOAs within the larger area that are deprived. Typically, this is done by dividing the LSOAs for the whole of Wales into <a href="https://en.wikipedia.org/wiki/Decile" target="_blank">deciles</a> based on deprivation rank, and calculating the proportion of LSOAs within the larger area that are in Decile 1 (10% most deprived in Wales), Decile 2 (20% most deprived in Wales), Decile 3 (30% most deprived in Wales), and so on. 
WIMD computes an **overall index of deprivation** based on the weighted sum of 8 sub-domains (listed below), each of which are underpinned by numerous indicator datasets. The figures in brackets refer to the weights (i.e. importance) assigned to each sub-domain when calculating overall (or "multiple") deprivation.

1. Income (22%)
2. Employment (22%)
3. Health (15%)
4. Education (14%)
5. Access to Services (10%)
6. Housing (7%)
7. Community Safety (5%)
8. Physical Environment (5%)

The current version of WIMD (WIMD 2019 - used in this project) was released in November 2019. For more information on WIMD, visit the Welsh Government's <a href="https://wimd.gov.wales/?lang=en" target="_blank">WIMD site</a>. Those seeking in-depth background and technical information on WIMD should consult the [guidance documents and technical reports](https://gov.wales/welsh-index-multiple-deprivation-index-guidance). Across the rest of the UK, indices of deprivation datasets have also been produced for <a href="https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019" target="_blank">England</a>, <a href="http://www.gov.scot/collections/scottish-index-of-multiple-deprivation-2020/" target="_blank">Scotland</a>, and <a href="https://www.nisra.gov.uk/statistics/deprivation/northern-ireland-multiple-deprivation-measure-2017-nimdm2017" target="_blank">Northern Ireland</a>



## 3. Project Aim
While there exists a useful set of resources on mapping WIMD data in Wales, these are mainly web-based interactive map tools (e.g. <a href="https://wimd.gov.wales/explore?lang=en#domain=overall&&z=8&lat=52.4137&lng=-4.2000" target="_blank">(e.g. Welsh Government)</a>) and static maps of WIMD at national level (e.g. <a href="https://statswales.gov.wales/Catalogue/Community-Safety-and-Social-Inclusion/Welsh-Index-of-Multiple-Deprivation/WIMD-maps-2019)" target="_blank">(e.g. StatsWales</a>). The main aim of this project is to produce a **clear, consistent, and informative set of WIMD maps at local authority level**, designed for informing decision makers and the general public. An objective of project was to create the maps using <a href="https://en.wikipedia.org/wiki/Open_data" target="_blank">open data</a> and <a href="https://en.wikipedia.org/wiki/Free_and_open-source_software)" target="_blank">free and open source software</a> tools, and to make all of the maps, data, and technical resources (e.g. computer code and software files) accessible and freely available for anyone to use. This reflects the <a href="https://www.glos.ac.uk" target="_blank">University of Gloucestershire</a></a>'s commitment to promoting and advocating the use open source geospatial tools and open education as a participating member of The Open Source Geospatial Foundation (<a href="https://www.osgeo.org/" target="_blank">OSGeo</a>)



## 4. Maps {.tabset .tabset-fade .tabset-pills}

The **Atlas of Deprivation in Wales** comprises over 200 maps of WIMD data for the 22 local authorities in Wales, across 9 different deprivation themes (overall deprivation + the 8 deprivation domains - listed in [Section 2](#custom3)). Maps are best viewed when downloaded and displayed using a high-resolution monitor or (for best results) printed in hardcopy using a good-quality printer. The maps are available both as multi-page PDFs, containing maps on a particular deprivation theme for all 22 local authorities (option 1, below), and as individual map images (PNG format) organised by local authority (option 2, below).


### Map guide

A consistent map layout is used for all maps in the Atlas:

![Example map from the Atlas of Deprivation in Wales (overall deprivation in Cardiff)](C:/Users\\Rob\\Dropbox\\R\\4_Projects\\Work\\WalesDeprivationAtlas\\Web_page\\map_layout.png)

The main map window shows the LSOA areas for the target local authority. Surrounding local authority areas are dimmed. A brief description of the deprivation theme being mapped is shown in the box in the top-right of the map layout, along with a "Rank" number indicating how the local authority compares to other local authorities in Wales, based on the proportion of LSOAs that are within the most deprived 30% nationally (note that if another figure - e.g. 10% - was used then the rank order would be slightly different for most themes). The main panel to right of the map provides a colour-coded legend (or "bargend" - **see section X**)in the form of a horizontal bar chart. The coloured bars correspond to the coloured LSOA polygons on the map, and show the proportion of LSOAs in the target local authority area that fall within each national deprivation decile for Wales. LSOAs in Decile 1 are among the 10% most deprived in Wales, while LSOAs in Decile 10 are among the least deprived 10%. The "About this map" section provides a brief guide to the map. A map legend for place name markers and road and rail features is shown at the bottom right. 


### 1. **Maps by deprivation theme** (PDF)

* **OVERALL DEPRIVATION**
    + Colour scheme 1 - "Viridis" (colourblind friendly)
    + <a href="https://drive.google.com/file/d/1tNXKowlk1CpmvZlYDzqbsRi1XoCOGCoL/view?usp=sharing" target="_blank">Colour scheme 2</a> - "Spectral" (multicolour)
    + Colour scheme 3 - Blue-yellow
* Employment
* Health
* Education
* Access to Services
* Housing
* Community Safety
* Physical Environment

### 2. **Maps by local authority** (PNG images)

* Blaenau Gwent
* Bridgend 
* Caerphilly
* Cardiff
* Carmarthenshire
* Ceredigion
* Conwy
* Denbighshire
* Flintshire
* Gwynedd
* Isle of Anglesey
* Merthyr Tydfil
* Monmouthshire
* Neath Port Talbot
* Newport
* Pembrokeshire
* Powys
* Rhondda Cynon Taf
* Swansea
* Torfaen
* Vale of Glamorgan
* Wrexham




## 5. Methodology {#custom2}

This section provides a brief overview of the work undertaken to produce the maps. Should they wish, anyone with a good knowledge of QGIS and R should be able to reproduce this project using the online resources and the information provided below. A more detailed step-by-step tutorial is planned. 

All of the resources necessary to reproduce this work, including input data, R code and QGIS project files are available via the project's GitHub repository: <a href="https://github.com/robertberryuk/WalesDeprivationAtlas" target="_blank">https://github.com/robertberryuk/WalesDeprivationAtlas</a>


### 5.1 Data Sources

* WIMD 2019 LSOA shapefiles (x 9) from <a href="http://lle.gov.wales/catalogue/itwgisem/WelshIndexOfMultipleDeprivationWIMD2019/?lang=en" target="_blank">Lle Geoportal for Wales</a>
* LSOA to aggregated geographies lookup table CSV from <a href="https://statswales.gov.wales/Catalogue/Community-Safety-and-Social-Inclusion/Welsh-Index-of-Multiple-Deprivation" target="_blank">StatsWales</a>
* NUTS Level 1 (January 2018) Ultra Generalised Clipped Boundaries in the United Kingdom shapefile from the <a href="http://geoportal.statistics.gov.uk/datasets/nuts-level-1-january-2018-boundaries?layer=4" target="_blank">Office for National Statistics</a>
* OS Open Names shapefile from the <a href="https://www.ordnancesurvey.co.uk/business-government/products/open-map-names" target="_blank">Ordnance Survey</a>
* OS Open Roads shapefile from the <a href="https://www.ordnancesurvey.co.uk/business-government/products/open-map-roads" target="_blank">Ordnance Survey</a>
* OS Strategi shapefile from the <a href="https://osdatahub.os.uk/downloads/open/Strategi" target="_blank">Ordnance Survey</a>


### 5.2 Software

* <a href="https://www.r-project.org/" target="_blank">R</a> Version 3.6.1 (2019-07-05) -- "Action of the Toes"
* <a href="https://rstudio.com/" target="_blank">RStudio</a> Version 1.2.5001
* <a href="https://qgis.org/en/site/" target="_blank">QGIS</a> Version 3.4.8- "Maderia"


### 5.3 Data processing in R


#### 5.3.1 WIMD data processing 

The code for this section can be found in the file **Scripts/1_WIMD_Pre-processing.R**

**Step 1** - The WIMD LSOA shapefiles from the Lle Geoportal do not have a local authority name or code column in the attribute table (see below), so the first objective was to add this attribute using the LSOA lookup table downloaded from StatsWales. 

![](C:/Users\\Rob\\Dropbox\\R\\4_Projects\\Work\\WalesDeprivationAtlas\\Web_page\\WIMD_attribute_table1.png)

&nbsp;



The R code first loads the required libraries then clears any existing shapefile outputs generated from previous running of the script. The LSOA to local authority lookup is then imported, and each of the 9 x WIMD LSOA shapefiles are loaded using a for loop. 

```{r eval=FALSE}

#> LOAD LIBRARIES
library(sf) #> spatial data handling
library(tidyverse) #> General data processing 
library(here) #> Create relative paths to files (for better portability and reproducibility)


#> 1. CLEAR (DELETE) ANY PREVIOUS SHAPEFILE OUTPUTS GENERATED FROM THIS SCRIPT (otherwise error will be thrown when trying to overwrite files on export)
#> Create list of existing WIMD shapefile outputs
shapes.WIMD <- here("Data", "Out", "Shapefiles", "WIMD")
#> Delete shapefiles
do.call(file.remove, list(list.files(shapes.WIMD, full.names = TRUE)))
#> Create list of any existing local authority stats outputs
shapes.LA <- here("Data", "Out", "Shapefiles", "Local_Authority_Stats")
#> Delete shapefiles
do.call(file.remove, list(list.files(shapes.LA, full.names = TRUE)))


#> 2. IMPORT WIMD LSOA shapefiles (Overall deprivation + 8 deprivation domains) 
#> First import LSOA to local authority lookup table
LA.lookup <- read_csv(here("Data", "In", "3_lookups", "LSOA_LA_Lookup.csv"))
#> Create list of WIMD domain names for use in import loop, processing, and export
domain <- c("access_to_services", "community_safety", "education", "employment", 
            "health", "housing", "income", "overall", "physical_environment")
#> For loop to import WIMD shapefiles 
#> (controlled by iterating through the WIMD domains in the "domain" character list)
for (i in 1:length(domain)) {
  #> Import file and sore as sf object "shp"
  shp <- st_read(here("Data", "In", "1_Shapefiles", "WIMD", paste0("WIMD2019_", domain[i], ".shp")))


```
&nbsp;

**Step 2** - Continuing in the loop, merge each of the imported shapefiles with the LSOA to local authority lookup table to add a local authority name attribute, and export updated LSOA shapefiles for use in QGIS. 

```{r eval=FALSE}

#> 3. MERGE
#> Merge WIMD LSOA domain shapefiles with LSOA-locaL authority lookup file to add local authority attribute to each imported WIMD shapefile
wimd.merge <- merge(shp, LA.lookup, by.x = "lsoa_code", by.y = "LSOA")

#> 4. EXPORT MERGED WIMD SHAPEFILES 
st_write(wimd.merge, here("Data", "Out", "Shapefiles", "WIMD", (paste0("WIMD_", domain[i], ".shp"))))
```

&nbsp;

**Step 3** - Now that a local authority name attribute has been appended to each of the 9 WIMD shapefiles, continue processing the shapefile attribute tables in the loop to generate a set of summary statistics for each domain per local authority (no of LSOAs in each WIMD decile, total number of LSOAs in each local authority, and percentage of LSOAs in each decile) - these statistics are then joined to a local authority boundary shapefile and used to drive the Atlas layout in QGIS. Also generated are statitic showing how the target local authority ranks alongside other local authorities for a particual deprivation domain, and a "Map_No" column is added to populate the "Map No" label in the QGIS Atlas layout. Note the local authority boundary shapefile was created by dissolving a WIMD LSOA polygon layer in QGIS rather than downloading a shapefile of local authorities - this was to ensure the LSOA boundaries and local authority boundaries were an exact fit on the map.


```{r eval=FALSE}

#> 5. GENERATE LOCAL AUTHORITY STATS FOR VISUALISTION IN QGIS Atlas:
#> "Bargend" stats - group by local authrity and count number of LSOAs in each decile, 
#> total number of LSOAs, and percentage of LSOAs in each decile 
#> Create non-geo version of LSOA data
LSOA.stats <- wimd.merge
st_geometry(LSOA.stats) <- NULL
#> Create a pivoted table showing number of LSOAs in each decile, with deciles 1-10 as columns
LSOA.sum <- LSOA.stats %>% 
  group_by(LA_Name, decile) %>% 
  tally() %>% 
  pivot_wider(names_from = decile, values_from = n) %>% 
  ungroup()
#> Add the "decile" prefix to the newly-generated LSOA-decile count columns
colnames(LSOA.sum)[2:11] <- paste("Dec_", colnames(LSOA.sum[,c(2:11)]), sep = "")
#> Change the NAs that are generated to zeros
LSOA.sum[is.na(LSOA.sum)] <- 0
#> Add a column for total mumber of LSOAs in each LA
LSOA.sum$Total_LSOAs <- rowSums(LSOA.sum[2:11])
#> Create a new dataframe of percentage columns (i.e percentage of LSOAs in each decile, for each LA)
df.percent <- (LSOA.sum[, 2:11] / LSOA.sum[[12]] * 100)
#> Round (to 1 decimal point)
df.percent <- round(df.percent, digits = 1)
#> Change column prefix from "Decile_1" to "PC_Decile_1 ("PC" = percent)
colnames(df.percent)[1:10] <- paste("PC_", colnames(df.percent[,c(1:10)]), sep = "")
#> Append percentage columns to LSOA sum dataframe using cbind
LSOA.sum <- data.frame(cbind(LSOA.sum, df.percent))
#> Add percentage total column (for checking)
LSOA.sum$PC_Total <- rowSums(LSOA.sum[13:22])
#> Add columns showing the percentage of LSOAs in: decile 1, (most deprived 10% LSOAs in Wales); 
#> deciles 1-2 (most deprived 20% LSOAs in Wales); 
#> deciles 1-3 (most deprived 30% LSOAs in Wales); deciles 1-5 (most deprived 50% LSOAs in Wales)
LSOA.sum$Dep_10 <- LSOA.sum$PC_Dec_1
LSOA.sum$Dep_20 <- LSOA.sum$PC_Dec_1 + LSOA.sum$PC_Dec_2
LSOA.sum$Dep_30 <- LSOA.sum$PC_Dec_1 + LSOA.sum$PC_Dec_2 + LSOA.sum$PC_Dec_3
LSOA.sum$Dep_50 <- LSOA.sum$PC_Dec_1 + LSOA.sum$PC_Dec_2 + LSOA.sum$PC_Dec_3 + LSOA.sum$PC_Dec_4 + LSOA.sum$PC_Dec_5
#> Add rank columns based on deprivation summary columns (i.e columns Dep_10 to Dep_50) - for "Rank" label in QGIS map layout
LSOA.sum <- arrange(LSOA.sum, desc(Dep_10)) %>%
  mutate(Rank_10 = 1:nrow(LSOA.sum))
LSOA.sum <- arrange(LSOA.sum, desc(Dep_20)) %>%
  mutate(Rank_20 = 1:nrow(LSOA.sum))
LSOA.sum <- arrange(LSOA.sum, desc(Dep_30)) %>%
  mutate(Rank_30 = 1:nrow(LSOA.sum))
LSOA.sum <- arrange(LSOA.sum, desc(Dep_50)) %>%
  mutate(Rank_50 = 1:nrow(LSOA.sum))
#> Add a column containing integers 1:22 for map page numbering in QGIS (based on alphabetical order of LAs)
LSOA.sum <- LSOA.sum %>% 
  arrange(LA_Name) %>% 
  mutate(Map_No = 1:nrow(LSOA.sum))

#> 6. MERGE THE LOCAL AUTHORITY DEPRIVATION STATS WITH LOCAL AUTHORITY SPATIAL BOUNDARY LAYER, THEN EXPORT AS SHAPEFILE
#> Import the LA boundary data (this file was created by dissolving an LSOA shapefile in QGIS
LAs <- st_read(here("Data", "In", "1_Shapefiles", "Local_Authorities.shp"))
#> Remove unwanted columns (i.e. all but geom and LA_Name)
LAs <- LAs %>% 
  select(LA_Name)
#> Merge
LA_stats.geo <- merge(LAs, LSOA.sum, by = "LA_Name")
#> Export
st_write(LA_stats.geo, here("Data", "Out", "Shapefiles", "Local_Authority_Stats", paste0("LA_Stats_", domain[i], ".shp")))

#> End the loop
}

```



#### 5.3.1 Place name data processing

Want did not have the resources to do Welsh version (all the resources are there if someone wanted to do it!).


### 5.4 Map production in QGIS


Semi-automated in th esense that you set up template and change a few parapemets and text...

No post precessing of the images - onluy QGIS used


QGIS layout - show the raw template

## 6. Acknowledgements

Alisdair Rae. Richard Fry.
Funded by the Countryide and Community Research Institute (CCRI), University of Gloucestershire


© Robert Berry, 2020

Tags - ONS, bbc wakes, #gischat #rstats #qgis public health Wales, Alistair Rae, rich fry, CCRI, Lucy Clarke, glosgeog, wag - social, senedd research. 
